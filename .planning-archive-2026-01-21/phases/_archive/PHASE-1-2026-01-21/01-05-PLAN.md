# 01-05: ProjectManagerDialog CRUD UI + Uniqueness Validation

**Parent**: PHASE-1
**Step**: 5 of 5
**Status**: Pending

## Objective

Implement full CRUD UI for Projects and Packages in the ProjectManagerDialog, including inline validation for uniqueness constraints and proper error handling.

## Components to Build

### Component 1: ProjectList

**File**: `src/components/ProjectList.tsx`

```typescript
import { useState } from 'react';
import { Project } from '@/types/database';
import { Pencil, Trash2, Check, X, Plus } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

interface ProjectListProps {
  projects: Project[];
  selectedId: number | null;
  onSelect: (id: number, name: string) => void;
  onCreate: (jobNumber: string) => Promise<void>;
  onUpdate: (id: number, jobNumber: string) => Promise<void>;
  onDelete: (id: number) => Promise<void>;
}

export function ProjectList({
  projects,
  selectedId,
  onSelect,
  onCreate,
  onUpdate,
  onDelete,
}: ProjectListProps) {
  const [editingId, setEditingId] = useState<number | null>(null);
  const [editValue, setEditValue] = useState('');
  const [isCreating, setIsCreating] = useState(false);
  const [newJobNumber, setNewJobNumber] = useState('');
  const [errors, setErrors] = useState<Record<number, string>>({});

  const startEdit = (project: Project) => {
    setEditingId(project.id);
    setEditValue(project.job_number);
    setErrors((prev) => ({ ...prev, [project.id]: '' }));
  };

  const cancelEdit = () => {
    setEditingId(null);
    setEditValue('');
    setErrors({});
  };

  const handleSave = async (id: number) => {
    // Validation
    if (!editValue.trim()) {
      setErrors((prev) => ({ ...prev, [id]: 'Job number is required' }));
      return;
    }

    // Check for duplicates (excluding current)
    const isDuplicate = projects.some(
      (p) => p.id !== id && p.job_number.toLowerCase() === editValue.toLowerCase()
    );

    if (isDuplicate) {
      setErrors((prev) => ({ ...prev, [id]: 'This job number already exists' }));
      return;
    }

    try {
      await onUpdate(id, editValue.trim());
      setEditingId(null);
      setEditValue('');
      setErrors({});
    } catch (error) {
      setErrors((prev) => ({ ...prev, [id]: String(error) }));
    }
  };

  const handleCreate = async () => {
    // Validation
    if (!newJobNumber.trim()) {
      setErrors((prev) => ({ ...prev, new: 'Job number is required' }));
      return;
    }

    // Check for duplicates
    const isDuplicate = projects.some(
      (p) => p.job_number.toLowerCase() === newJobNumber.toLowerCase()
    );

    if (isDuplicate) {
      setErrors((prev) => ({ ...prev, new: 'This job number already exists' }));
      return;
    }

    try {
      await onCreate(newJobNumber.trim());
      setNewJobNumber('');
      setIsCreating(false);
      setErrors({});
    } catch (error) {
      setErrors((prev) => ({ ...prev, new: String(error) }));
    }
  };

  const handleDelete = async (id: number, name: string) => {
    if (!confirm(`Delete project "${name}" and all its packages?`)) {
      return;
    }

    try {
      await onDelete(id);
    } catch (error) {
      alert(String(error));
    }
  };

  return (
    <div className="space-y-4">
      {/* Create new project */}
      {isCreating ? (
        <div className="flex gap-2 items-start">
          <div className="flex-1">
            <Input
              value={newJobNumber}
              onChange={(e) => setNewJobNumber(e.target.value)}
              placeholder="Enter job number (e.g., 14403)"
              onKeyDown={(e) => e.key === 'Enter' && handleCreate()}
              autoFocus
            />
            {errors.new && (
              <p className="text-sm text-red-600 mt-1">{errors.new}</p>
            )}
          </div>
          <Button size="sm" onClick={handleCreate}>
            <Check className="w-4 h-4" />
          </Button>
          <Button
            size="sm"
            variant="outline"
            onClick={() => {
              setIsCreating(false);
              setNewJobNumber('');
              setErrors((prev) => ({ ...prev, new: '' }));
            }}
          >
            <X className="w-4 h-4" />
          </Button>
        </div>
      ) : (
        <Button
          variant="outline"
          className="w-full"
          onClick={() => setIsCreating(true)}
        >
          <Plus className="w-4 h-4 mr-2" />
          New Project
        </Button>
      )}

      {/* Project list */}
      <div className="border rounded-lg divide-y max-h-96 overflow-y-auto">
        {projects.map((project) => (
          <div
            key={project.id}
            className={`
              flex items-center gap-2 p-3
              ${selectedId === project.id ? 'bg-blue-50' : ''}
            `}
          >
            {editingId === project.id ? (
              <>
                <Input
                  value={editValue}
                  onChange={(e) => setEditValue(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleSave(project.id)}
                  className="flex-1"
                  autoFocus
                />
                <Button size="sm" onClick={() => handleSave(project.id)}>
                  <Check className="w-4 h-4" />
                </Button>
                <Button
                  size="sm"
                  variant="outline"
                  onClick={cancelEdit}
                >
                  <X className="w-4 h-4" />
                </Button>
              </>
            ) : (
              <>
                <button
                  onClick={() => onSelect(project.id, project.job_number)}
                  className="flex-1 text-left font-medium hover:text-blue-600"
                >
                  {project.job_number}
                </button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => startEdit(project)}
                >
                  <Pencil className="w-4 h-4" />
                </Button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => handleDelete(project.id, project.job_number)}
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </>
            )}
            {errors[project.id] && (
              <p className="col-span-3 text-sm text-red-600">
                {errors[project.id]}
              </p>
            )}
          </div>
        ))}

        {projects.length === 0 && !isCreating && (
          <div className="p-8 text-center text-gray-500">
            No projects yet. Create your first project to get started.
          </div>
        )}
      </div>
    </div>
  );
}
```

### Component 2: PackageList

**File**: `src/components/PackageList.tsx`

```typescript
import { useState } from 'react';
import { Package } from '@/types/database';
import { Pencil, Trash2, Check, X, Plus } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

interface PackageListProps {
  projectId: number;
  packages: Package[];
  selectedId: number | null;
  onSelect: (id: number, name: string) => void;
  onCreate: (projectId: number, name: string) => Promise<void>;
  onUpdate: (id: number, name: string) => Promise<void>;
  onDelete: (id: number) => Promise<void>;
}

export function PackageList({
  projectId,
  packages,
  selectedId,
  onSelect,
  onCreate,
  onUpdate,
  onDelete,
}: PackageListProps) {
  const [editingId, setEditingId] = useState<number | null>(null);
  const [editValue, setEditValue] = useState('');
  const [isCreating, setIsCreating] = useState(false);
  const [newName, setNewName] = useState('');
  const [errors, setErrors] = useState<Record<number | 'new', string>>({});

  const startEdit = (pkg: Package) => {
    setEditingId(pkg.id);
    setEditValue(pkg.name);
    setErrors((prev) => ({ ...prev, [pkg.id]: '' }));
  };

  const cancelEdit = () => {
    setEditingId(null);
    setEditValue('');
    setErrors({});
  };

  const handleSave = async (id: number) => {
    // Validation
    if (!editValue.trim()) {
      setErrors((prev) => ({ ...prev, [id]: 'Package name is required' }));
      return;
    }

    // Check for duplicates within this project
    const isDuplicate = packages.some(
      (p) => p.id !== id && p.name.toLowerCase() === editValue.toLowerCase()
    );

    if (isDuplicate) {
      setErrors((prev) => ({
        ...prev,
        [id]: 'A package with this name already exists in this project',
      }));
      return;
    }

    try {
      await onUpdate(id, editValue.trim());
      setEditingId(null);
      setEditValue('');
      setErrors({});
    } catch (error) {
      setErrors((prev) => ({ ...prev, [id]: String(error) }));
    }
  };

  const handleCreate = async () => {
    // Validation
    if (!newName.trim()) {
      setErrors((prev) => ({ ...prev, new: 'Package name is required' }));
      return;
    }

    // Check for duplicates
    const isDuplicate = packages.some(
      (p) => p.name.toLowerCase() === newName.toLowerCase()
    );

    if (isDuplicate) {
      setErrors((prev) => ({
        ...prev,
        new: 'A package with this name already exists in this project',
      }));
      return;
    }

    try {
      await onCreate(projectId, newName.trim());
      setNewName('');
      setIsCreating(false);
      setErrors({});
    } catch (error) {
      setErrors((prev) => ({ ...prev, new: String(error) }));
    }
  };

  const handleDelete = async (id: number, name: string) => {
    // Note: This should check if package has BOM runs before deleting
    if (!confirm(`Delete package "${name}"? Any associated BOM data will be lost.`)) {
      return;
    }

    try {
      await onDelete(id);
    } catch (error) {
      alert(String(error));
    }
  };

  return (
    <div className="space-y-4">
      <div className="text-sm text-gray-600">
        Packages for the selected project
      </div>

      {/* Create new package */}
      {isCreating ? (
        <div className="flex gap-2 items-start">
          <div className="flex-1">
            <Input
              value={newName}
              onChange={(e) => setNewName(e.target.value)}
              placeholder="Enter package name (e.g., Main Assembly)"
              onKeyDown={(e) => e.key === 'Enter' && handleCreate()}
              autoFocus
            />
            {errors.new && (
              <p className="text-sm text-red-600 mt-1">{errors.new}</p>
            )}
          </div>
          <Button size="sm" onClick={handleCreate}>
            <Check className="w-4 h-4" />
          </Button>
          <Button
            size="sm"
            variant="outline"
            onClick={() => {
              setIsCreating(false);
              setNewName('');
              setErrors((prev) => ({ ...prev, new: '' }));
            }}
          >
            <X className="w-4 h-4" />
          </Button>
        </div>
      ) : (
        <Button
          variant="outline"
          className="w-full"
          onClick={() => setIsCreating(true)}
        >
          <Plus className="w-4 h-4 mr-2" />
          New Package
        </Button>
      )}

      {/* Package list */}
      <div className="border rounded-lg divide-y max-h-96 overflow-y-auto">
        {packages.map((pkg) => (
          <div
            key={pkg.id}
            className={`
              flex items-center gap-2 p-3
              ${selectedId === pkg.id ? 'bg-blue-50' : ''}
            `}
          >
            {editingId === pkg.id ? (
              <>
                <Input
                  value={editValue}
                  onChange={(e) => setEditValue(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleSave(pkg.id)}
                  className="flex-1"
                  autoFocus
                />
                <Button size="sm" onClick={() => handleSave(pkg.id)}>
                  <Check className="w-4 h-4" />
                </Button>
                <Button
                  size="sm"
                  variant="outline"
                  onClick={cancelEdit}
                >
                  <X className="w-4 h-4" />
                </Button>
              </>
            ) : (
              <>
                <button
                  onClick={() => onSelect(pkg.id, pkg.name)}
                  className="flex-1 text-left font-medium hover:text-blue-600"
                >
                  {pkg.name}
                </button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => startEdit(pkg)}
                >
                  <Pencil className="w-4 h-4" />
                </Button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => handleDelete(pkg.id, pkg.name)}
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </>
            )}
            {errors[pkg.id] && (
              <p className="col-span-3 text-sm text-red-600">
                {errors[pkg.id]}
              </p>
            )}
          </div>
        ))}

        {packages.length === 0 && !isCreating && (
          <div className="p-8 text-center text-gray-500">
            No packages yet. Create your first package to get started.
          </div>
        )}
      </div>
    </div>
  );
}
```

### Component 3: BomWorkspace (placeholder)

**File**: `src/components/BomWorkspace.tsx`

```typescript
export function BomWorkspace() {
  return (
    <div className="text-center py-12">
      <h2 className="text-xl font-semibold text-gray-900 mb-2">
        BOM Workspace
      </h2>
      <p className="text-gray-600">
        This is where the BOM translation workflow will be implemented in Phase 2.
      </p>
      <p className="text-sm text-gray-500 mt-4">
        For now, the project/package scoping is complete.
      </p>
    </div>
  );
}
```

## Integration

Update `src/components/ProjectManagerDialog.tsx` to import and use these components:

```typescript
import { ProjectList } from './ProjectList';
import { PackageList } from './PackageList';

// Replace the placeholder rendering with:
{tab === 'projects' && (
  <ProjectList
    projects={projects}
    onSelect={handleSelectProject}
    onCreate={createProject}
    onUpdate={updateProject}
    onDelete={deleteProject}
    selectedId={selectedProjectId}
  />
)}

{tab === 'packages' && selectedProjectId && (
  <PackageList
    projectId={selectedProjectId}
    packages={packages}
    onSelect={handleSelectPackage}
    onCreate={createPackage}
    onUpdate={updatePackage}
    onDelete={deletePackage}
  />
)}
```

## Testing Checklist

### Project CRUD
- [ ] Create new project with valid job number
- [ ] Cannot create project with duplicate job number
- [ ] Cannot create project with empty job number
- [ ] Edit project job number
- [ ] Cannot edit to duplicate job number
- [ ] Delete project with confirmation
- [ ] Select project by clicking
- [ ] Selected project is highlighted

### Package CRUD
- [ ] Create new package with valid name
- [ ] Cannot create package with duplicate name in same project
- [ ] Cannot create package with empty name
- [ ] Edit package name
- [ ] Cannot edit to duplicate name in same project
- [ ] Delete package with confirmation
- [ ] Select package by clicking
- [ ] Selected package is highlighted

### UI/UX
- [ ] Inline validation errors show immediately
- [ ] Keyboard shortcuts (Enter to save, Esc to cancel)
- [ ] Focus management on create/edit
- [ ] Empty states show helpful messages
- [ ] Loading states during async operations
- [ ] Toast notifications for success/error

### Blocking Modal
- [ ] Cannot close dialog without selecting scope when blocking
- [ ] "Continue" button only enabled when scope is selected
- [ ] Closing dialog via "Continue" button navigates to BOM workspace

## Dependencies

- **Requires**: 01-04 (Dialog skeleton)
- **Completes**: Phase 1

## Definition of Done

- `src/components/ProjectList.tsx` created
- `src/components/PackageList.tsx` created
- `src/components/BomWorkspace.tsx` created
- `src/components/ProjectManagerDialog.tsx` fully implemented
- All CRUD operations working
- Uniqueness validation working (DB + UI)
- Blocking modal behavior working
- No TypeScript errors
- No ESLint errors
- All Phase 1 requirements met

## Phase 1 Completion Checklist

After this plan is complete:

- [ ] PROJ-01: Project CRUD operations working
- [ ] PROJ-02: Projects contain multiple packages
- [ ] PROJ-03: Package names can repeat across projects
- [ ] PROJ-04: Package names unique within project
- [ ] PROJ-05: BOM entry opens Project Manager modal
- [ ] APP-01: Landing page with module tiles
- [ ] Phase 1 success criteria met
- [ ] Can proceed to Phase 2

---
**Created**: 2026-01-20
**Est. Time**: 90 minutes
