# PLAN-02-01: BOM Translation Release Rails â€” Core Infrastructure

**Phase:** 02-bom-translation-release-rails
**Created:** 2026-01-21
**Status:** Draft

## Objective

Establish the core database schema and type infrastructure for BOM Translation features, including run history, mapping templates, and input file storage.

## Success Criteria

1. Database migrations exist for `bom_runs`, `mapping_templates`, and `bom_run_inputs` tables
2. TypeScript types define the shape of BOM runs, templates, and related entities
3. DB client functions expose CRUD operations for templates and run history
4. Input file blob storage strategy is implemented (SQLite blob or filesystem reference)

## Changes

### Database Schema

**File:** `src-tauri/migrations/006_bom_translation_core.sql`

```sql
-- BOM Translation Run History
CREATE TABLE IF NOT EXISTS bom_runs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  package_scope_id INTEGER NOT NULL,
  started_at TEXT NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  completed_at TEXT,
  status TEXT NOT NULL DEFAULT 'running', -- 'running', 'completed', 'failed', 'cancelled'
  input_file_hash TEXT NOT NULL,
  mapping_id INTEGER,
  settings_json TEXT NOT NULL, -- export settings snapshot
  output_file_hash TEXT,
  error_message TEXT,
  FOREIGN KEY (package_scope_id) REFERENCES package_scopes(id) ON DELETE CASCADE,
  FOREIGN KEY (mapping_id) REFERENCES mapping_templates(id) ON DELETE SET NULL
);

-- Mapping Templates (per-project)
CREATE TABLE IF NOT EXISTS mapping_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  project_id INTEGER NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  is_default INTEGER NOT NULL DEFAULT 0, -- boolean: exactly one per project
  created_at TEXT NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  updated_at TEXT NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  mappings_json TEXT NOT NULL, -- { [sourceCol: string]: targetField: string }
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  UNIQUE(project_id, name)
);

-- Ensure only one default template per project
CREATE UNIQUE INDEX IF NOT EXISTS idx_mapping_default
  ON mapping_templates(project_id)
  WHERE is_default = 1;

-- BOM Run Input Files (audit trail)
CREATE TABLE IF NOT EXISTS bom_run_inputs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  bom_run_id INTEGER NOT NULL,
  original_filename TEXT NOT NULL,
  file_blob BLOB, -- SQLite blob storage (alternative: file_path TEXT for filesystem)
  file_size INTEGER NOT NULL,
  uploaded_at TEXT NOT NULL DEFAULT (CURRENT_TIMESTAMP),
  FOREIGN KEY (bom_run_id) REFERENCES bom_runs(id) ON DELETE CASCADE
);

-- Indexes for common queries
CREATE INDEX IF NOT EXISTS idx_bom_runs_package
  ON bom_runs(package_scope_id, started_at DESC);

CREATE INDEX IF NOT EXISTS idx_mapping_templates_project
  ON mapping_templates(project_id, name);
```

### TypeScript Types

**File:** `src/types/bom.ts`

```typescript
// BOM Run Status
export type BomRunStatus = 'running' | 'completed' | 'failed' | 'cancelled';

// BOM Run Entity
export interface BomRun {
  id: number;
  package_scope_id: number;
  started_at: string;
  completed_at?: string;
  status: BomRunStatus;
  input_file_hash: string;
  mapping_id?: number;
  settings_json: string; // ExportSettings
  output_file_hash?: string;
  error_message?: string;
}

// Mapping Template Entity
export interface MappingTemplate {
  id: number;
  project_id: number;
  name: string;
  description?: string;
  is_default: boolean;
  created_at: string;
  updated_at: string;
  mappings_json: string; // Record<string, string>
}

// BOM Run Input File Entity
export interface BomRunInput {
  id: number;
  bom_run_id: number;
  original_filename: string;
  file_blob: Uint8Array | null; // null if using filesystem ref
  file_size: number;
  uploaded_at: string;
}

// Export Settings (stored as JSON in bom_runs)
export interface ExportSettings {
  format: 'zw1';
  version: string;
  // Additional export options
}

// Column Mapping
export type ColumnMapping = Record<string, string>; // { [sourceCol]: targetField }
```

### Database Client Functions

**File:** `src/lib/db/client.ts` (extend existing)

```typescript
import { BomRun, MappingTemplate, BomRunInput, ColumnMapping } from '@/types/bom';

export const bomRuns = {
  // Create a new BOM run
  create: (packageScopeId: number, inputFileHash: string, settings: ExportSettings) =>
    execute<BomRun>(
      `INSERT INTO bom_runs (package_scope_id, input_file_hash, settings_json)
       VALUES (?, ?, ?)`,
      [packageScopeId, inputFileHash, JSON.stringify(settings)]
    ),

  // Update run status
  updateStatus: (id: number, status: BomRunStatus, completedAt?: string, errorMessage?: string) =>
    execute(
      `UPDATE bom_runs
       SET status = ?, completed_at = COALESCE(?, completed_at), error_message = ?
       WHERE id = ?`,
      [status, completedAt, errorMessage, id]
    ),

  // Get run history for a package
  getByPackage: (packageScopeId: number, limit = 50) =>
    query<BomRun>(
      `SELECT * FROM bom_runs
       WHERE package_scope_id = ?
       ORDER BY started_at DESC
       LIMIT ?`,
      [packageScopeId, limit]
    ),

  // Get a single run with input file
  getById: (id: number) =>
    query<BomRun & { input?: BomRunInput }>(
      `SELECT
         br.*,
         bri.id as input_id,
         bri.original_filename,
         bri.file_blob,
         bri.file_size,
         bri.uploaded_at
       FROM bom_runs br
       LEFT JOIN bom_run_inputs bri ON bri.bom_run_id = br.id
       WHERE br.id = ?`,
      [id]
    ).then(rows => rows[0]),
};

export const mappingTemplates = {
  // Get all templates for a project
  getByProject: (projectId: number) =>
    query<MappingTemplate>(
      `SELECT * FROM mapping_templates
       WHERE project_id = ?
       ORDER BY name ASC`,
      [projectId]
    ),

  // Get default template for a project
  getDefault: (projectId: number) =>
    query<MappingTemplate>(
      `SELECT * FROM mapping_templates
       WHERE project_id = ? AND is_default = 1`,
      [projectId]
    ).then(rows => rows[0]),

  // Create a new template (sets as default if it's the first)
  create: (
    projectId: number,
    name: string,
    description: string | undefined,
    mappings: ColumnMapping
  ) =>
    execute<MappingTemplate>(
      `INSERT INTO mapping_templates (project_id, name, description, mappings_json, is_default)
       VALUES (?, ?, ?, ?, COALESCE((SELECT 0 FROM mapping_templates WHERE project_id = ? LIMIT 1), 1))`,
      [projectId, name, description, JSON.stringify(mappings), projectId]
    ),

  // Update an existing template
  update: (id: number, name: string, description: string | undefined, mappings: ColumnMapping) =>
    execute(
      `UPDATE mapping_templates
       SET name = ?, description = ?, mappings_json = ?, updated_at = CURRENT_TIMESTAMP
       WHERE id = ?`,
      [name, description, JSON.stringify(mappings), id]
    ),

  // Clone a template
  clone: (id: number, newName: string) =>
    execute<MappingTemplate>(
      `INSERT INTO mapping_templates (project_id, name, description, mappings_json, is_default)
       SELECT project_id, ?, name || ' (copy)', mappings_json, 0
       FROM mapping_templates
       WHERE id = ?`,
      [newName, id]
    ),

  // Delete a template
  delete: (id: number) =>
    execute(`DELETE FROM mapping_templates WHERE id = ?`, [id]),

  // Set as default (clears other defaults for the project)
  setDefault: (id: number) =>
    execute(
      `UPDATE mapping_templates
       SET is_default = CASE WHEN id = ? THEN 1 ELSE 0 END
       WHERE project_id = (SELECT project_id FROM mapping_templates WHERE id = ?)`,
      [id, id]
    ),
};

export const bomRunInputs = {
  // Store input file blob for a run
  create: (bomRunId: number, filename: string, fileBlob: Uint8Array) =>
    execute<BomRunInput>(
      `INSERT INTO bom_run_inputs (bom_run_id, original_filename, file_blob, file_size)
       VALUES (?, ?, ?, ?)`,
      [bomRunId, filename, fileBlob, fileBlob.length]
    ),

  // Get input file for a run
  getByBomRunId: (bomRunId: number) =>
    query<BomRunInput>(
      `SELECT * FROM bom_run_inputs WHERE bom_run_id = ?`,
      [bomRunId]
    ).then(rows => rows[0]),
};
```

## Verification

1. Run migration: Verify tables exist with correct schema
2. Test template CRUD: Create, update, clone, delete, set default
3. Test run history: Create runs, update status, retrieve by package
4. Test input storage: Store and retrieve file blob
5. Verify constraints: Default template uniqueness, cascade deletes

## Dependencies

- Existing `projects` and `package_scopes` tables (from Phase 1)
- Existing `src/lib/db/client.ts` structure

## Risks

- SQLite blob storage may impact performance for large files; consider filesystem reference if needed
- JSON columns require manual parsing/validation in application code
