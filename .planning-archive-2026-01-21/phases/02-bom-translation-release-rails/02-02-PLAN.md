---
phase: 02-bom-translation-release-rails
plan: 02
type: execute
wave: 1
depends_on:
  - 02-01
files_modified:
  - src-tauri/src/commands.rs
  - src/types/bom.ts
  - src/stores/bom-translation-store.ts
  - src/components/bom-translation/FileUploader.tsx
  - src/components/bom-translation/SheetSelector.tsx
  - src/components/bom-translation/ColumnMapper.tsx
  - src/components/bom-translation/MappingTemplateManager.tsx
  - src/lib/db/client.ts
autonomous: true

must_haves:
  truths:
    - "User can import an .xlsx file and select a sheet"
    - "Column headers are auto-mapped using fuzzy matching to known fields"
    - "User can manually adjust mappings and save as a template"
    - "Unmapped columns show a warning but allow proceeding"
    - "Data preview shows first 5 rows during mapping"
  artifacts:
    - path: "src-tauri/src/commands.rs"
      provides: "Tauri commands for Excel parsing"
      contains: "parse_excel_file"
    - path: "src/stores/bom-translation-store.ts"
      provides: "Zustand store for BOM translation state"
      contains: "useBOMTranslationStore"
    - path: "src/components/bom-translation/ColumnMapper.tsx"
      provides: "UI for mapping source columns to target fields"
      contains: "ColumnMapper component"
  key_links:
    - from: "src/stores/bom-translation-store.ts"
      to: "src-tauri/src/commands.rs"
      via: "invoke('parse_excel_file')"
      pattern: "invoke\\('parse_excel_file'"
    - from: "src/stores/bom-translation-store.ts"
      to: "src/lib/db/client.ts"
      via: "mappingTemplates"
      pattern: "mappingTemplates\\.(getByProject|create|update)"
---

<objective>
Implement Excel file import, sheet selection, and column mapping UI with fuzzy auto-mapping and template management.

Purpose: Allow users to bring in BOM data from Excel and map it to the system's expected structure.
Output: Working file import flow with mapping UI, template CRUD, and data preview.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-bom-translation-release-rails/02-CONTEXT.md
@.planning/phases/02-bom-translation-release-rails/02-01-PLAN.md

@src/types/bom.ts
@src/stores/bom-store.ts
@src/lib/db/client.ts
@src-tauri/src/commands.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Tauri command for Excel file parsing</name>
  <files>src-tauri/src/commands.rs</files>
  <action>
Add a new Tauri command `parse_excel_file` that:

1. Accepts: file path (string), sheet index (optional number)
2. Uses the `calamine` crate to read .xlsx files
3. Returns: sheet names (string[]) + selected sheet data (headers + rows)
4. Includes first 5 rows of data for preview

Return shape:
```rust
#[derive(Serialize)]
struct ExcelSheetData {
    sheets: Vec<String>,
    selected_sheet: String,
    headers: Vec<String>,
    preview_rows: Vec<Vec<serde_json::Value>>, // Mixed types (string, number, bool)
    total_rows: usize,
}
```

Add `calamine` to `Cargo.toml` dependencies if not present.

Error handling: Return actionable errors for corrupt files, password protection, or empty sheets.
  </action>
  <verify>
Run: `cargo check --manifest-path src-tauri/Cargo.toml`
  </verify>
  <done>
Tauri command compiles and can parse .xlsx files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BOM Translation Zustand store</name>
  <files>src/stores/bom-translation-store.ts</files>
  <action>
Create a new store `useBOMTranslationStore` with the following state and actions:

**State:**
- `uploadedFile: File | null`
- `sheets: string[]`
- `selectedSheetIndex: number`
- `headers: string[]`
- `previewRows: Record<string, unknown>[][]`
- `totalRows: number`
- `columnMapping: Record<string, string>` // source header -> target field
- `unmappedColumns: string[]`
- `mappingTemplates: MappingTemplate[]`
- `selectedTemplateId: number | null`
- `loading: boolean`
- `error: string | null`

**Target Fields (fixed list for .zw1 export):**
- `part_number`
- `quantity`
- `description`
- `manufacturer`
- `manufacturer_part_number`
- `location`
- `reference_designators`
- `attributes` (catch-all for extra fields)

**Actions:**
- `uploadFile(file: File)` - invokes Tauri command, loads sheets, defaults to sheet 0
- `selectSheet(index: number)` - re-invokes with sheet index
- `autoMapColumns()` - fuzzy match headers to target fields (normalize: lowercase, strip spaces, common synonyms)
- `setMapping(sourceCol: string, targetField: string | null)` - manual mapping
- `loadTemplates(projectId: number)` - load templates from DB
- `saveAsTemplate(name: string, description: string)` - save current mapping as template
- `applyTemplate(templateId: number)` - apply saved mapping to current data
- `resetMapping()` - clear all mappings
- `clearAll()` - reset store state

**Fuzzy matching algorithm (simple):**
- Normalize both strings: lowercase, trim, remove special chars
- Direct match: "partNumber" === "part_number"
- Synonym map: { "pn": "part_number", "p/n": "part_number", "qty": "quantity", "mfg": "manufacturer", ... }
- Word containment: "manufacturer_part" contains "part" -> match part_number (lower confidence)
  </action>
  <verify>
Run: `npm run build`
  </verify>
  <done>
Store compiles and provides all required state/actions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build FileUploader + SheetSelector components</name>
  <files>
src/components/bom-translation/FileUploader.tsx
src/components/bom-translation/SheetSelector.tsx
  </files>
  <action>
Create two components:

**FileUploader.tsx:**
- Drag-and-drop zone with click-to-browse
- Accepts `.xlsx` files only
- Shows file name, size, and upload progress
- Calls `uploadFile` from store on selection
- Uses shadcn `Card` + `Button` + icons

**SheetSelector.tsx:**
- Dropdown/tabs to select sheet (only shown if multiple sheets exist)
- Shows sheet name + row count
- Calls `selectSheet` from store
- Disabled while loading
  </action>
  <verify>
Run: `npm run build` and `npm run lint`
  </verify>
  <done>
Components render without errors and integrate with store.
  </done>
</task>

<task type="auto">
  <name>Task 4: Build ColumnMapper component with fuzzy auto-mapping</name>
  <files>src/components/bom-translation/ColumnMapper.tsx</files>
  <action>
Create `ColumnMapper.tsx` with:

**Layout:**
- Table with columns: Source Header | Target Field | Status
- Each source header row has a dropdown to select target field (or "Unmapped")
- Status indicator: ✓ Mapped | ⚠️ Unmapped
- Search/filter to find columns quickly

**Features:**
- Auto-map button that runs `autoMapColumns()` and updates UI
- Clear all mappings button
- Shows warning if any required fields (part_number, quantity) are unmapped
- Shows preview of first 5 rows below mapping table

**Visual feedback:**
- Mapped columns: green badge
- Unmapped columns: yellow/warning badge
- Required but unmapped: red badge with clear message

Integration with store:
- Read `headers`, `columnMapping`, `unmappedColumns`
- Call `setMapping` on dropdown change
- Call `autoMapColumns` on auto-map button click
  </action>
  <verify>
Run: `npm run build` and `npm run lint`
  </verify>
  <done>
ColumnMapper renders, allows manual mapping, and triggers auto-mapping.
  </done>
</task>

<task type="auto">
  <name>Task 5: Build MappingTemplateManager component</name>
  <files>src/components/bom-translation/MappingTemplateManager.tsx</files>
  <action>
Create `MappingTemplateManager.tsx` with:

**UI:**
- List of existing templates (name, description, updated_at)
- "Save current mapping as template" button
- "Apply template" buttons per row
- "Set as default" checkbox/star
- "Delete template" button (with confirmation)
- "Clone template" button

**Save template flow:**
- Dialog with name (required), description (optional) inputs
- Calls `saveAsTemplate` from store
- Shows success toast

**Apply template flow:**
- Validates that template columns exist in current file
- If mismatch: show error with missing columns
- If valid: calls `applyTemplate` and updates ColumnMapper

Uses shadcn `Dialog`, `Button`, `AlertDialog`.
  </action>
  <verify>
Run: `npm run build` and `npm run lint`
  </verify>
  <done>
TemplateManager lists templates, saves new ones, and applies them with validation.
  </done>
</task>

<task type="auto">
  <name>Task 6: Create BOM Translation page that orchestrates the flow</name>
  <files>src/pages/bom-translation-page.tsx</files>
  <action>
Create or update the BOM Translation page with step-by-step flow:

**Step 1: Upload**
- Show `FileUploader`
- On success, advance to Step 2

**Step 2: Map Columns**
- Show `SheetSelector` (if multiple sheets)
- Show `ColumnMapper` with preview
- Show `MappingTemplateManager`
- "Next" button is disabled if required fields unmapped (with tooltip explaining why)
- Warn if unmapped columns exist, but allow proceeding

**Step 3: Review (placeholder for next plan)**
- Show "Review and Edit" (disabled, links to next plan)

Layout uses shadcn `Card`, `Stepper` (or simple steps UI), `Button`.
  </action>
  <verify>
Run: `npm run build`
  </verify>
  <done>
Page renders full import + mapping flow with proper gating.
  </done>
</task>

<task type="auto">
  <name>Task 7: Extend DB client with template helper for default detection</name>
  <files>src/lib/db/client.ts</files>
  <action>
Add a helper to `mappingTemplates` in `src/lib/db/client.ts`:

```typescript
// Get the template to auto-apply when importing
getAutoApplyTemplate: (projectId: number, headers: string[]) =>
  query<MappingTemplate>(
    `SELECT * FROM mapping_templates
     WHERE project_id = ? AND is_default = 1`,
    [projectId]
  ).then(templates => {
    // Return default template if it's compatible with headers
    const template = templates[0];
    if (template) {
      const mappings = JSON.parse(template.mappings_json) as Record<string, string>;
      const requiredCols = Object.values(mappings);
      const hasAllCols = requiredCols.every(col => headers.includes(col));
      return hasAllCols ? template : null;
    }
    return null;
  }),
```

This allows the UI to auto-apply the default template if it's compatible.
  </action>
  <verify>
Run: `npm run build`
  </verify>
  <done>
DB client provides auto-apply template logic.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm run lint` succeeds
- Upload an .xlsx file and verify sheets are listed
- Select a sheet and verify headers + preview load
- Click "Auto-map" and verify reasonable column mappings
- Manually adjust mappings and verify they persist
- Save a template, verify it appears in the template list
- Apply a template with compatible columns, verify mapping updates
- Apply a template with incompatible columns, verify error is shown
</verification>

<success_criteria>
- User can import .xlsx and select sheets
- Auto-mapping correctly detects common column name variants
- User can manually correct mappings and save templates
- Unmapped columns show warnings but don't strictly block proceeding
- Required field validation prevents proceeding if part_number or quantity are unmapped
</success_criteria>

<output>
After completion, create `.planning/phases/02-bom-translation-release-rails/02-02-SUMMARY.md`
</output>
