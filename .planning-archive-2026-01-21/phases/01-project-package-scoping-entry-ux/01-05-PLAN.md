---
phase: 01-project-package-scoping-entry-ux
plan: 05
type: execute
wave: 5
depends_on:
  - 01-04
files_modified:
  - src/components/bom/project-manager-dialog.tsx
autonomous: false

must_haves:
  truths:
    - "User can create/select/rename/delete Projects (job #) and Packages"
    - "Selected Package becomes the active BOM workspace scope"
    - "Package names are unique within a Project"
  artifacts:
    - path: "src/components/bom/project-manager-dialog.tsx"
      provides: "Blocking Project/Package manager modal with Project/Package CRUD and selection"
      min_lines: 120
  key_links:
    - from: "src/components/bom/project-manager-dialog.tsx"
      to: "src/stores/bom-store.ts"
      via: "useBOMStore actions for job project/package CRUD + setScope"
      pattern: "useBOMStore\\(\\)"
    - from: "src/components/bom/project-manager-dialog.tsx"
      to: "sqlite UNIQUE constraint error strings"
      via: "RHF setError mapping"
      pattern: "UNIQUE constraint failed: bom_(job_projects|packages)"
---

<objective>
Implement the ProjectManagerDialog Project/Package CRUD UI with inline uniqueness errors.

Purpose: Users can manage Projects (job #) and Packages without leaving the BOM workspace, and uniqueness rules are surfaced as inline form errors.
Output: Updated `ProjectManagerDialog` supporting full CRUD + selection, wired to `useBOMStore`.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-project-package-scoping-entry-ux/01-CONTEXT.md
@.planning/phases/01-project-package-scoping-entry-ux/01-RESEARCH.md
@.planning/phases/01-project-package-scoping-entry-ux/01-04-PLAN.md

@src/components/bom/project-manager-dialog.tsx
@src/stores/bom-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace ProjectManagerDialog UI to manage Projects + Packages (CRUD + selection)</name>
  <files>src/components/bom/project-manager-dialog.tsx</files>
  <action>
Replace the existing single-table "projects" UI with a Project(job#) + Package manager that supports:

- Layout: either a two-column master/detail (job projects left, packages right), OR a single table grouped by project_number.
- Create flow requires BOTH job project number + initial package name (per context).

CRUD operations (wire to `useBOMStore()` actions from Plan 01-03):
- Create job project + initial package
- Create additional package under an existing job project
- Rename job project
- Rename package
- Delete job project (cascades; confirm via AlertDialog)
- Delete package (confirm via AlertDialog)

Selection:
- Selecting a package calls `useBOMStore().setScope(packageId)` and then closes the dialog.

Blocking behavior:
- Dialog `open` stays controlled by parent.
- Do not add additional "can't close" logic here; Plan 01-04 is responsible for the gating via the parent.

Notifications:
- Use `toast.success` for successful create/rename/delete.
- Use `toast.error` only for non-field/unexpected failures.
  </action>
  <verify>
Run: `npm run build`
  </verify>
  <done>
Dialog supports Project + Package CRUD and package selection (setScope + close) with no TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add RHF + Zod validation and inline uniqueness constraint errors (real SQLite)</name>
  <files>src/components/bom/project-manager-dialog.tsx</files>
  <action>
Forms + validation:

- Use React Hook Form + Zod (already in repo) for create/rename flows.
- Project number and package name: trim + required (no additional format rules).

Uniqueness errors MUST show inline under the relevant field (no toast) by mapping SQLite errors:
- `UNIQUE constraint failed: bom_job_projects.project_number` -> setError('project_number', { message: ... })
- `UNIQUE constraint failed: bom_packages.project_id, bom_packages.package_name` -> setError('package_name', { message: ... })

Implementation notes:
- Treat the caught error as `unknown`; extract message safely (stringify `Error` or fallback to `String(e)`).
- Only map the known UNIQUE constraint errors; for all other errors use `toast.error`.
  </action>
  <verify>
Run: `npm run tauri:dev` and manually test create/rename conflicts to confirm inline errors show.
  </verify>
  <done>
When a uniqueness constraint is violated in the real SQLite DB, the correct RHF field shows an inline error message and the dialog remains usable.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 1 end-to-end entry UX (BOM entry gating + Project/Package CRUD + scope selection + uniqueness feedback).
  </what-built>
  <how-to-verify>
1) Run `npm run tauri:dev`.
2) From Home, click "BOM Translation".
   - Expected: Project Manager modal opens immediately.
   - Expected: You cannot dismiss it (ESC/outside click) until you select a Package.
3) Create a new Project + initial Package.
   - Expected: After selecting the package, the BOM workspace loads.
4) Create a 2nd Package under the same Project.
   - Expected: Both packages exist; selecting either switches the BOM scope.
5) Try creating/renaming a Package to a name that already exists within the same Project.
   - Expected: Inline error under package name input.
6) Create another Project with the same Package name.
   - Expected: Allowed.
7) Delete a Project.
   - Expected: Confirmation dialog shows; after confirm, project/packages are removed.
8) Verify landing page tiles:
   - Non-ready modules are disabled and labeled "Coming soon"; clicking does nothing.
  </how-to-verify>
  <resume-signal>Type "approved" or describe what failed (include screenshots if helpful).</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds.
- Human verification steps above pass.
</verification>

<success_criteria>
- Phase 1 roadmap success criteria #1-#4 are satisfied in the running desktop app.
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-package-scoping-entry-ux/01-05-SUMMARY.md`
</output>
