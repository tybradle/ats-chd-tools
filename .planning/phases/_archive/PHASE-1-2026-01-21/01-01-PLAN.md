# 01-01: SQLite Migration for Projects/Packages

**Parent**: PHASE-1
**Step**: 1 of 5
**Status**: Pending

## Objective

Add database schema to support Project(job#) → Package hierarchy with proper constraints and cascade rules.

## Database Schema

### Tables to Create

```sql
-- Migration: 006_add_projects_packages.sql
-- Description: Add project and package scoping tables

CREATE TABLE IF NOT EXISTS projects (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  job_number TEXT NOT NULL UNIQUE,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS packages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(project_id, name)
);

CREATE INDEX IF NOT EXISTS idx_packages_project_id ON packages(project_id);
```

## Implementation Steps

### Step 1.1: Create Migration File
- **File**: `src-tauri/migrations/006_add_projects_packages.sql`
- **Action**: Write schema SQL
- **Verify**: SQL syntax is valid

### Step 1.2: Update BOM Table (if needed)
- **Assessment**: Check if `bom_runs` or similar tables exist
- **Action**: Add `package_id` foreign key if BOM data exists
- **Fallback**: If no BOM tables yet, skip (will be handled in Phase 2)

### Step 1.3: Test Migration
- **Action**: Run migration in development database
- **Verify**: Tables created with correct schema
- **Verify**: Indexes created
- **Verify**: Foreign key constraints work

### Step 1.4: Add Rollback Script
- **File**: `src-tauri/migrations/rollback/006_add_projects_packages.sql`
- **Content**: `DROP TABLE IF EXISTS packages; DROP TABLE IF EXISTS projects;`

## TypeScript Types

Add to `src/types/database.ts`:

```typescript
export interface Project {
  id: number;
  job_number: string;
  created_at: string;
  updated_at: string;
}

export interface Package {
  id: number;
  project_id: number;
  name: string;
  created_at: string;
  updated_at: string;
}

export interface ProjectWithPackages extends Project {
  packages: Package[];
}
```

## Edge Cases Handled

1. **Duplicate job numbers**: UNIQUE constraint prevents
2. **Orphaned packages**: ON DELETE CASCADE cleans up when project deleted
3. **Duplicate package names**: UNIQUE(project_id, name) enforces per-project uniqueness
4. **Same name across projects**: Allowed by design (only unique within project)

## Testing Checklist

- [ ] Migration runs without errors
- [ ] Projects table created with correct schema
- [ ] Packages table created with correct schema
- [ ] UNIQUE constraint on projects.job_number works
- [ ] UNIQUE constraint on packages(project_id, name) works
- [ ] Foreign key cascade deletes work (delete project → packages removed)
- [ ] Index on packages.project_id created
- [ ] Rollback script works

## Dependencies

- **Requires**: Existing Tauri SQLite plugin setup
- **Blocks**: 01-02 (DB helpers + types)

## Definition of Done

- Migration file created at `src-tauri/migrations/006_add_projects_packages.sql`
- Migration tested successfully in dev environment
- Rollback script created and tested
- TypeScript types added to `src/types/database.ts`
- No existing migrations broken

---
**Created**: 2026-01-20
**Est. Time**: 30 minutes
