# 01-02: Database Helpers + Types for Projects/Packages

**Parent**: PHASE-1
**Step**: 2 of 5
**Status**: Pending

## Objective

Add type-safe query functions to `src/lib/db/client.ts` for CRUD operations on projects and packages, including mock data helpers for development.

## Requirements

- All queries use parameterized statements (no string interpolation)
- TypeScript types from 01-01 are imported and used
- Mock data helpers for testing without database
- Proper error handling with user-friendly messages

## Implementation

### File: `src/lib/db/client.ts`

Add the following sections:

```typescript
import { Project, Package, ProjectWithPackages } from '@/types/database';

// ============================================================================
// PROJECTS
// ============================================================================

export const projects = {
  // Get all projects ordered by job number
  getAll: async (): Promise<Project[]> => {
    return query<Project>(
      'SELECT * FROM projects ORDER BY job_number ASC'
    );
  },

  // Get project by ID
  getById: async (id: number): Promise<Project | null> => {
    const results = await query<Project>(
      'SELECT * FROM projects WHERE id = ?',
      [id]
    );
    return results[0] || null;
  },

  // Get project with packages
  getWithPackages: async (id: number): Promise<ProjectWithPackages | null> => {
    const project = await projects.getById(id);
    if (!project) return null;

    const packages = await packages.getByProjectId(id);
    return { ...project, packages };
  },

  // Create new project
  create: async (jobNumber: string): Promise<Project> => {
    const result = await execute(
      'INSERT INTO projects (job_number) VALUES (?)',
      [jobNumber]
    );
    return projects.getById(result.lastInsertId) as Promise<Project>;
  },

  // Update project job number
  update: async (id: number, jobNumber: string): Promise<void> => {
    await execute(
      'UPDATE projects SET job_number = ?, updated_at = datetime("now") WHERE id = ?',
      [jobNumber, id]
    );
  },

  // Delete project (cascade deletes packages)
  delete: async (id: number): Promise<void> => {
    await execute('DELETE FROM projects WHERE id = ?', [id]);
  },

  // Check if job number exists (for validation)
  jobNumberExists: async (jobNumber: string, excludeId?: number): Promise<boolean> => {
    let sql = 'SELECT COUNT(*) as count FROM projects WHERE job_number = ?';
    const params: (string | number)[] = [jobNumber];

    if (excludeId !== undefined) {
      sql += ' AND id != ?';
      params.push(excludeId);
    }

    const result = await query<{count: number}>(sql, params);
    return (result[0]?.count ?? 0) > 0;
  }
};

// ============================================================================
// PACKAGES
// ============================================================================

export const packages = {
  // Get all packages across all projects
  getAll: async (): Promise<Package[]> => {
    return query<Package>(
      'SELECT * FROM packages ORDER BY project_id, name ASC'
    );
  },

  // Get packages for a specific project
  getByProjectId: async (projectId: number): Promise<Package[]> => {
    return query<Package>(
      'SELECT * FROM packages WHERE project_id = ? ORDER BY name ASC',
      [projectId]
    );
  },

  // Get package by ID
  getById: async (id: number): Promise<Package | null> => {
    const results = await query<Package>(
      'SELECT * FROM packages WHERE id = ?',
      [id]
    );
    return results[0] || null;
  },

  // Create new package in a project
  create: async (projectId: number, name: string): Promise<Package> => {
    const result = await execute(
      'INSERT INTO packages (project_id, name) VALUES (?, ?)',
      [projectId, name]
    );
    return packages.getById(result.lastInsertId) as Promise<Package>;
  },

  // Update package name
  update: async (id: number, name: string): Promise<void> => {
    await execute(
      'UPDATE packages SET name = ?, updated_at = datetime("now") WHERE id = ?',
      [name, id]
    );
  },

  // Delete package
  delete: async (id: number): Promise<void> => {
    await execute('DELETE FROM packages WHERE id = ?', [id]);
  },

  // Check if package name exists in project (for validation)
  nameExistsInProject: async (
    projectId: number,
    name: string,
    excludeId?: number
  ): Promise<boolean> => {
    let sql = 'SELECT COUNT(*) as count FROM packages WHERE project_id = ? AND name = ?';
    const params: (number | string)[] = [projectId, name];

    if (excludeId !== undefined) {
      sql += ' AND id != ?';
      params.push(excludeId);
    }

    const result = await query<{count: number}>(sql, params);
    return (result[0]?.count ?? 0) > 0;
  }
};
```

### Mock Data Helpers

Add to `src/lib/db/mock.ts` (create if doesn't exist):

```typescript
import { Project, Package } from '@/types/database';

export const mockProjects: Project[] = [
  { id: 1, job_number: '14403', created_at: '2026-01-01', updated_at: '2026-01-01' },
  { id: 2, job_number: '14415', created_at: '2026-01-05', updated_at: '2026-01-05' },
];

export const mockPackages: Package[] = [
  { id: 1, project_id: 1, name: 'Main Assembly', created_at: '2026-01-01', updated_at: '2026-01-01' },
  { id: 2, project_id: 1, name: 'Sub-Assembly A', created_at: '2026-01-02', updated_at: '2026-01-02' },
  { id: 3, project_id: 2, name: 'Main Assembly', created_at: '2026-01-05', updated_at: '2026-01-05' },
];

// Simulates DB operations for testing without database
export const mockDb = {
  projects: {
    getAll: async () => mockProjects,
    getById: async (id: number) => mockProjects.find(p => p.id === id) || null,
    create: async (jobNumber: string) => {
      const newProject: Project = {
        id: Math.max(...mockProjects.map(p => p.id)) + 1,
        job_number: jobNumber,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
      };
      mockProjects.push(newProject);
      return newProject;
    },
  },
  packages: {
    getByProjectId: async (projectId: number) =>
      mockPackages.filter(p => p.project_id === projectId),
    create: async (projectId: number, name: string) => {
      const newPackage: Package = {
        id: Math.max(...mockPackages.map(p => p.id)) + 1,
        project_id: projectId,
        name,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
      };
      mockPackages.push(newPackage);
      return newPackage;
    },
  },
};
```

## Error Handling

All functions should handle common errors:

```typescript
// Example error handling in execute function
try {
  return await execute(sql, params);
} catch (error) {
  // Check for UNIQUE constraint violation
  if (String(error).includes('UNIQUE constraint')) {
    throw new Error('This name already exists. Please use a different name.');
  }
  // Check for FOREIGN KEY violation
  if (String(error).includes('FOREIGN KEY constraint')) {
    throw new Error('Cannot delete project with existing packages.');
  }
  // Generic error
  throw new Error(`Database operation failed: ${error}`);
}
```

## Validation Helper

Add to `src/lib/validation.ts`:

```typescript
export const projectValidation = {
  jobNumber: (value: string): string | null => {
    if (!value.trim()) return 'Job number is required';
    if (value.length > 50) return 'Job number must be 50 characters or less';
    return null;
  },
};

export const packageValidation = {
  name: (value: string): string | null => {
    if (!value.trim()) return 'Package name is required';
    if (value.length > 100) return 'Package name must be 100 characters or less';
    return null;
  },
};
```

## Testing Checklist

- [ ] All CRUD functions implemented
- [ ] Parameterized queries used (no string interpolation)
- [ ] TypeScript types match database schema
- [ ] Mock data helpers work without database
- [ ] Validation helpers catch edge cases
- [ ] Error handling covers UNIQUE and FOREIGN KEY constraints
- [ ] All functions export from `src/lib/db/client.ts`

## Dependencies

- **Requires**: 01-01 (migration + types)
- **Blocks**: 01-03 (Zustand stores)

## Definition of Done

- All query functions added to `src/lib/db/client.ts`
- Mock helpers added to `src/lib/db/mock.ts`
- Validation helpers added to `src/lib/validation.ts`
- All functions tested with manual testing
- TypeScript compilation succeeds
- No ESLint errors

---
**Created**: 2026-01-20
**Est. Time**: 45 minutes
