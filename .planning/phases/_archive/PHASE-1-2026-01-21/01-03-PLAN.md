# 01-03: BOM Zustand Store Refactoring (Package-Scope-First)

**Parent**: PHASE-1
**Step**: 3 of 5
**Status**: Pending

## Objective

Refactor the BOM Zustand store to require an active package scope before any BOM operations can occur, ensuring data is always associated with a specific package.

## Current State Analysis

### Identify Existing BOM Store

First, locate the existing BOM store:

```bash
# Expected location
src/stores/bom-store.ts
# or
src/stores/useBomStore.ts
```

### Current Issues to Fix

1. **No package scope**: BOM data not associated with any project/package
2. **Can operate without context**: User can import BOM without selecting a project
3. **No scope validation**: No checks for active package before operations

## Implementation Plan

### Step 1: Create Active Scope Store

**File**: `src/stores/active-scope-store.ts`

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface ActiveScopeState {
  projectId: number | null;
  projectName: string | null;
  packageId: number | null;
  packageName: string | null;

  // Actions
  setProject: (id: number, name: string) => void;
  setPackage: (id: number, name: string) => void;
  clearScope: () => void;
  hasScope: () => boolean;
}

export const useActiveScopeStore = create<ActiveScopeState>()(
  persist(
    (set, get) => ({
      projectId: null,
      projectName: null,
      packageId: null,
      packageName: null,

      setProject: (id, name) => set({
        projectId: id,
        projectName: name,
        // Clear package when project changes
        packageId: null,
        packageName: null,
      }),

      setPackage: (id, name) => set({
        packageId: id,
        packageName: name,
      }),

      clearScope: () => set({
        projectId: null,
        projectName: null,
        packageId: null,
        packageName: null,
      }),

      hasScope: () => {
        const { projectId, packageId } = get();
        return projectId !== null && packageId !== null;
      },
    }),
    {
      name: 'active-scope-storage',
    }
  )
);
```

### Step 2: Create Project Store

**File**: `src/stores/project-store.ts`

```typescript
import { create } from 'zustand';
import { projects } from '@/lib/db/client';
import { Project } from '@/types/database';
import { toast } from 'sonner';

interface ProjectState {
  projects: Project[];
  loading: boolean;
  error: string | null;

  // Actions
  fetchProjects: () => Promise<void>;
  createProject: (jobNumber: string) => Promise<void>;
  updateProject: (id: number, jobNumber: string) => Promise<void>;
  deleteProject: (id: number) => Promise<void>;
}

export const useProjectStore = create<ProjectState>((set) => ({
  projects: [],
  loading: false,
  error: null,

  fetchProjects: async () => {
    set({ loading: true, error: null });
    try {
      const result = await projects.getAll();
      set({ projects: result, loading: false });
    } catch (e) {
      set({ error: String(e), loading: false });
      toast.error('Failed to load projects');
    }
  },

  createProject: async (jobNumber: string) => {
    set({ loading: true, error: null });
    try {
      await projects.create(jobNumber);
      const result = await projects.getAll();
      set({ projects: result, loading: false });
      toast.success(`Project "${jobNumber}" created`);
    } catch (e) {
      set({ error: String(e), loading: false });
      toast.error(String(e));
    }
  },

  updateProject: async (id: number, jobNumber: string) => {
    set({ loading: true, error: null });
    try {
      await projects.update(id, jobNumber);
      const result = await projects.getAll();
      set({ projects: result, loading: false });
      toast.success(`Project renamed to "${jobNumber}"`);
    } catch (e) {
      set({ error: String(e), loading: false });
      toast.error(String(e));
    }
  },

  deleteProject: async (id: number) => {
    set({ loading: true, error: null });
    try {
      await projects.delete(id);
      const result = await projects.getAll();
      set({ projects: result, loading: false });
      toast.success('Project deleted');
    } catch (e) {
      set({ error: String(e), loading: false });
      toast.error(String(e));
    }
  },
}));
```

### Step 3: Create Package Store

**File**: `src/stores/package-store.ts`

```typescript
import { create } from 'zustand';
import { packages } from '@/lib/db/client';
import { Package } from '@/types/database';
import { toast } from 'sonner';

interface PackageState {
  packages: Package[];
  loading: boolean;
  error: string | null;

  // Actions
  fetchPackages: (projectId: number) => Promise<void>;
  createPackage: (projectId: number, name: string) => Promise<void>;
  updatePackage: (id: number, name: string) => Promise<void>;
  deletePackage: (id: number) => Promise<void>;
}

export const usePackageStore = create<PackageState>((set) => ({
  packages: [],
  loading: false,
  error: null,

  fetchPackages: async (projectId: number) => {
    set({ loading: true, error: null });
    try {
      const result = await packages.getByProjectId(projectId);
      set({ packages: result, loading: false });
    } catch (e) {
      set({ error: String(e), loading: false });
      toast.error('Failed to load packages');
    }
  },

  createPackage: async (projectId: number, name: string) => {
    set({ loading: true, error: null });
    try {
      await packages.create(projectId, name);
      const result = await packages.getByProjectId(projectId);
      set({ packages: result, loading: false });
      toast.success(`Package "${name}" created`);
    } catch (e) {
      set({ error: String(e), loading: false });
      toast.error(String(e));
    }
  },

  updatePackage: async (id: number, name: string) => {
    set({ loading: true, error: null });
    try {
      await packages.update(id, name);
      // Re-fetch from the same project
      const currentPkg = await packages.getById(id);
      if (currentPkg) {
        const result = await packages.getByProjectId(currentPkg.project_id);
        set({ packages: result, loading: false });
      }
      toast.success(`Package renamed to "${name}"`);
    } catch (e) {
      set({ error: String(e), loading: false });
      toast.error(String(e));
    }
  },

  deletePackage: async (id: number) => {
    set({ loading: true, error: null });
    try {
      const pkg = await packages.getById(id);
      await packages.delete(id);
      if (pkg) {
        const result = await packages.getByProjectId(pkg.project_id);
        set({ packages: result, loading: false });
      }
      toast.success('Package deleted');
    } catch (e) {
      set({ error: String(e), loading: false });
      toast.error(String(e));
    }
  },
}));
```

### Step 4: Refactor BOM Store

**Modify**: Existing `src/stores/bom-store.ts`

Add scope checks to all operations:

```typescript
// Import the scope store
import { useActiveScopeStore } from './active-scope-store';

// Helper function to ensure scope is set
const requireScope = () => {
  const scope = useActiveScopeStore.getState();
  if (!scope.hasScope()) {
    throw new Error('Please select a Project and Package before continuing');
  }
  return scope;
};

// Example: Modify existing BOM operations
export const useBomStore = create<BomStore>((set) => ({
  // ... existing state ...

  importBom: async (file: File) => {
    // REQUIRE scope before importing
    const { projectId, packageId } = requireScope();

    set({ loading: true, error: null });
    try {
      // Pass packageId to database operations
      const result = await importBomData(file, { projectId, packageId });
      set({ data: result, loading: false });
      toast.success('BOM imported successfully');
    } catch (e) {
      set({ error: String(e), loading: false });
      if (String(e).includes('Please select')) {
        toast.error(e.message);
      } else {
        toast.error('Failed to import BOM');
      }
    }
  },

  exportBom: async () => {
    // REQUIRE scope before exporting
    const { projectId, packageId } = requireScope();

    set({ loading: true, error: null });
    try {
      const result = await exportBomData({ projectId, packageId });
      set({ loading: false });
      return result;
    } catch (e) {
      set({ error: String(e), loading: false });
      toast.error('Failed to export BOM');
      throw e;
    }
  },

  // ... apply to all other operations ...
}));
```

## Database Integration

If BOM tables exist, add migration to associate with packages:

```sql
-- If bom_runs table exists, add package_id
ALTER TABLE bom_runs ADD COLUMN package_id INTEGER REFERENCES packages(id);

-- Update existing records to a default package if needed
UPDATE bom_runs SET package_id = 1 WHERE package_id IS NULL;

-- Then make it NOT NULL
ALTER TABLE bom_runs ALTER COLUMN package_id INTEGER NOT NULL;
```

## Scope Check Hook

Create a convenience hook:

**File**: `src/hooks/useRequireScope.ts`

```typescript
import { useActiveScopeStore } from '@/stores/active-scope-store';
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router';

export function useRequireScope() {
  const navigate = useNavigate();
  const { hasScope } = useActiveScopeStore();
  const [checked, setChecked] = useState(false);

  useEffect(() => {
    if (!hasScope()) {
      // Redirect to project manager or open modal
      navigate('/bom?manage-scope=true');
    }
    setChecked(true);
  }, [hasScope, navigate]);

  return { hasScope: hasScope(), checked };
}
```

## Testing Checklist

- [ ] Active scope store created and persisting correctly
- [ ] Project store fetches/creates/updates/deletes
- [ ] Package store fetches/creates/updates/deletes
- [ ] BOM store requires scope before operations
- [ ] Error messages guide user to select project/package
- [ ] Scope persists across page reloads
- [ ] Clearing scope clears package when project changes
- [ ] All stores use the consistent pattern from AGENTS.md

## Dependencies

- **Requires**: 01-02 (DB helpers + types)
- **Blocks**: 01-04 (BOM routing integration)

## Definition of Done

- `src/stores/active-scope-store.ts` created
- `src/stores/project-store.ts` created
- `src/stores/package-store.ts` created
- Existing BOM store refactored with scope checks
- `src/hooks/useRequireScope.ts` created
- All stores follow the Zustand pattern from AGENTS.md
- No TypeScript errors
- No ESLint errors

---
**Created**: 2026-01-20
**Est. Time**: 60 minutes
