---
phase: 01-project-package-scoping-entry-ux
plan: 04
type: execute
wave: 4
depends_on:
  - 01-03
files_modified:
  - src/pages/bom.tsx
  - src/pages/bom-project.tsx
  - src/components/bom/project-manager-dialog.tsx
  - src/components/bom/location-tabs.tsx
  - src/components/bom/bom-table.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Landing page shows module tiles; non-ready modules are disabled and labeled 'Coming soon'"
    - "Entering BOM module immediately prompts a blocking Project Manager modal"
    - "User can create/select/rename/delete Projects (job #) and Packages"
    - "Selected Package becomes the active workspace scope"
    - "Package names are unique within a Project"
  artifacts:
    - path: "src/components/bom/project-manager-dialog.tsx"
      provides: "Blocking Project/Package manager modal"
    - path: "src/pages/bom.tsx"
      provides: "BOM workspace entry that enforces scope selection"
  key_links:
    - from: "src/pages/bom.tsx"
      to: "src/components/bom/project-manager-dialog.tsx"
      via: "controlled open state"
      pattern: "<ProjectManagerDialog.*open="
    - from: "src/components/bom/project-manager-dialog.tsx"
      to: "src/stores/bom-store.ts"
      via: "setScope/createJobProjectWithInitialPackage/etc"
      pattern: "useBOMStore\(\)"
---

<objective>
Deliver Phase 1 UX: BOM entry is always gated by a blocking Project/Package manager, and BOM workspace shows/changing scope in a left sidebar.

Purpose: Users reliably enter BOM Translation in the correct Project/Package context.
Output: Updated BOM pages, routing, and a Project Manager modal that supports full Project/Package CRUD with inline uniqueness errors.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-project-package-scoping-entry-ux/01-CONTEXT.md
@.planning/phases/01-project-package-scoping-entry-ux/01-RESEARCH.md

@src/pages/bom.tsx
@src/pages/bom-project.tsx
@src/components/bom/project-manager-dialog.tsx
@src/stores/bom-store.ts
@src/pages/home.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make /bom a workspace entry that always opens a blocking scope modal</name>
  <files>
src/pages/bom.tsx
src/App.tsx
src/pages/bom-project.tsx
  </files>
  <action>
Refactor routing + BOM entry UX per phase context:

1) Update `src/pages/bom.tsx` so it becomes the BOM workspace page (not the project list card). It must:
- On initial mount: open `ProjectManagerDialog` immediately.
- Keep dialog open (blocking) until `useBOMStore().currentScopePackageId` is set.
- Render the BOM workspace behind the modal, but keep it visually/interaction disabled until a scope is selected.

2) Keep (or temporarily keep) `BomProjectPage` route only as a compatibility redirect:
- Update `src/pages/bom-project.tsx` to read `projectId` param and call `useBOMStore().setScope(Number(projectId))` then navigate to `/bom` (or render `BomPage`).
- Even with a deep link, the modal should still open on `/bom` (context requires always prompting on entry).

3) Update `src/App.tsx`:
- Prefer a single `/bom` route as the main workspace entry.
- Keep `/bom/:projectId` route if needed for backwards compatibility, but ensure it ends up at `/bom`.

4) Add a left-side scope section inside the BOM page layout (within the page content area, not the app-wide sidebar):
- Show current job project number + package name.
- Provide a "Change" button that opens the ProjectManagerDialog.

Non-goals:
- Do not change the landing page scope display (explicitly excluded by context).
  </action>
  <verify>
Run: `npm run dev` and navigate to `http://localhost:1420/bom` â€” Project Manager modal opens immediately.
  </verify>
  <done>
Entering `/bom` always opens the modal, and BOM workspace cannot be used until a scope is selected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade ProjectManagerDialog to manage Projects + Packages with inline uniqueness errors</name>
  <files>src/components/bom/project-manager-dialog.tsx</files>
  <action>
Replace the existing single-table "projects" UI with a Project(job#) + Package manager that supports:

- List job projects (left column) and packages for the selected job project (right column) OR a single table grouped by project_number.
- Create flow requires BOTH job project number + initial package name (per context).
- CRUD operations:
  - Create job project + initial package
  - Create additional package under an existing job project
  - Rename job project
  - Rename package
  - Delete job project (cascades; confirm via AlertDialog)
  - Delete package (confirm via AlertDialog)
- Selecting a package calls `useBOMStore().setScope(packageId)` and closes the dialog.

Blocking behavior:
- Dialog `open` must be controlled by parent.
- Prevent closing via ESC/outside-click when `currentScopePackageId` is null.
- If `currentScopePackageId` is set, allow close.

Forms + validation:
- Use React Hook Form + Zod (already in repo) for create/rename forms.
- Project number and package name: trim + required (no additional format rules).
- Uniqueness errors MUST show inline under the relevant field (no toast) by mapping SQLite errors:
  - `UNIQUE constraint failed: bom_job_projects.project_number` -> setError('project_number', ...)
  - `UNIQUE constraint failed: bom_packages.project_id, bom_packages.package_name` -> setError('package_name', ...)

Notifications:
- Use `toast.success` for successful create/rename/delete.
- Use `toast.error` only for non-field/unexpected failures.
  </action>
  <verify>
Run: `npm run dev` and manually test create/rename conflicts to confirm inline errors show.
  </verify>
  <done>
Modal supports Project/Package CRUD and selection; uniqueness violations appear as inline field errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 1 end-to-end entry UX (BOM entry gating + Project/Package CRUD + scope selection).
  </what-built>
  <how-to-verify>
1) Run `npm run tauri:dev`.
2) From Home, click "BOM Translation".
   - Expected: Project Manager modal opens immediately.
   - Expected: You cannot dismiss it (ESC/outside click) until you select a Package.
3) Create a new Project + initial Package.
   - Expected: After selecting the package, the BOM workspace loads.
4) Create a 2nd Package under the same Project.
   - Expected: Both packages exist; selecting either switches the BOM scope.
5) Try creating/renaming a Package to a name that already exists within the same Project.
   - Expected: Inline error under package name input.
6) Create another Project with the same Package name.
   - Expected: Allowed.
7) Delete a Project.
   - Expected: Confirmation dialog shows; after confirm, project/packages are removed.
8) Verify landing page tiles:
   - Non-ready modules are disabled and labeled "Coming soon"; clicking does nothing.
  </how-to-verify>
  <resume-signal>Type "approved" or describe what failed (include screenshots if helpful).</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds.
- Human verification steps above pass.
</verification>

<success_criteria>
- Phase 1 roadmap success criteria #1-#4 are satisfied in the running desktop app.
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-package-scoping-entry-ux/01-04-SUMMARY.md`
</output>
