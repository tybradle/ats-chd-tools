---
phase: 01-project-package-scoping-entry-ux
plan: 06
type: execute
wave: 6
depends_on:
  - 01-04
files_modified:
  - src/pages/bom.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Entering /bom immediately opens Project Manager and it cannot be dismissed until a Package scope is selected"
    - "Dialog close gestures (ESC / outside click / close button) are ignored while no scope is selected"
  artifacts:
    - path: "src/pages/bom.tsx"
      provides: "BOM entry gating that is enforced consistently in all render branches"
      contains: "handleOpenChange"
  key_links:
    - from: "src/pages/bom.tsx"
      to: "src/components/bom/project-manager-dialog.tsx"
      via: "controlled open + guarded onOpenChange"
      pattern: "onOpenChange=\{handleOpenChange\}"
---

<objective>
Close verification gap: ensure the Project Manager modal is truly blocking on BOM entry in every code path.

Purpose: Prevent users from entering BOM workspace with no selected package scope.
Output: A single, consistent gating mechanism in `BomPage`.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-project-package-scoping-entry-ux/01-project-package-scoping-entry-ux-VERIFICATION.md

@src/pages/bom.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce guarded onOpenChange for ProjectManagerDialog in all BomPage branches</name>
  <files>src/pages/bom.tsx</files>
  <action>
Fix the gap described in `01-project-package-scoping-entry-ux-VERIFICATION.md`:

- In `src/pages/bom.tsx`, find ALL `ProjectManagerDialog` usages.
- Ensure every instance uses the same guarded `handleOpenChange` function (NOT `setIsProjectManagerOpen` directly).

Guarding rules:
- If `currentScopePackageId` is null/undefined:
  - `handleOpenChange(false)` MUST be ignored (keep dialog open).
  - This must block close via ESC/outside click/close button.
- If `currentScopePackageId` is set:
  - `handleOpenChange(false)` may close the dialog.

Structural guidance (pick ONE and implement cleanly):
1) Preferred: remove/avoid early-return branches that render a different dialog instance; always render a single page shell with the dialog overlay.
2) Acceptable: keep early-return UI, but still pass `onOpenChange={handleOpenChange}` and keep `open={true}` while no scope is selected.

Non-goal:
- Do not change `ProjectManagerDialog` internals here; the gating must be enforced purely by `BomPage` controlled props.
  </action>
  <verify>
Run: `npm run build`

Then, manual smoke test (quick):
1) `npm run tauri:dev`
2) Navigate to /bom
3) Try to close the dialog via ESC and by clicking outside
   - Expected: dialog stays open until a package is selected.
  </verify>
  <done>
No code path in `BomPage` allows `ProjectManagerDialog` to close while `currentScopePackageId` is null.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds.
- In dev runtime, dialog cannot be dismissed before selecting a package.
</verification>

<success_criteria>
- Phase 1 truth: “Entering BOM module immediately prompts a blocking Project Manager modal” is now achievable.
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-package-scoping-entry-ux/01-06-SUMMARY.md`
</output>
