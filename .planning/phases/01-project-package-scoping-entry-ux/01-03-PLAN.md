---
phase: 01-project-package-scoping-entry-ux
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - src/stores/bom-store.ts
autonomous: true

must_haves:
  truths:
    - "User can select a Package and it becomes the active BOM workspace scope"
    - "Changing scope resets BOM view to the selected Package's data"
  artifacts:
    - path: "src/stores/bom-store.ts"
      provides: "Scope-aware BOM store state + actions"
      contains: "currentScopePackageId"
  key_links:
    - from: "src/stores/bom-store.ts"
      to: "src/lib/db/client.ts"
      via: "bomJobProjects/bomPackages/bomLocations/bomItems"
      pattern: "bom(JobProjects|Packages|Locations|Items)"
---

<objective>
Refactor the BOM Zustand store to treat Package as the workspace scope, with job-project + package selection support.

Purpose: Make BOM pages render and load data based on a selected Package (scope).
Output: Updated `useBOMStore` with job projects, packages, and scope actions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-project-package-scoping-entry-ux/01-CONTEXT.md
@.planning/phases/01-project-package-scoping-entry-ux/01-RESEARCH.md

@src/stores/bom-store.ts
@src/lib/db/client.ts
@src/types/bom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scope-first state to useBOMStore (package scope)</name>
  <files>src/stores/bom-store.ts</files>
  <action>
Update the BOM store state shape to support Phase 1 hierarchy:

Add state:
- `jobProjects: BOMJobProject[]`
- `packages: BOMPackageWithCounts[]` (packages for the currently selected job project)
- `currentJobProjectId: number | null`
- `currentScopePackageId: number | null`
- `currentScope: (BOMPackage & { project_number: string }) | null` (joined display fields)

Keep existing state for locations/items, but reinterpret:
- All calls that previously used `currentProject.id` should now use `currentScopePackageId` as the `project_id` argument to `bomLocations`/`bomItems` (since those tables now reference packages).

Add a small “pending writes” mechanism to satisfy the phase decision about auto-saving drafts on scope switch:
- Track a `pendingWrites: number` counter (or a Set of Promises).
- When switching scope, await `flushPendingWrites()` before loading the next scope.
- This ensures optimistic updates are persisted before switching.

Do NOT introduce new DB tables for drafts in this phase.
  </action>
  <verify>
Run: `npm run build`
  </verify>
  <done>
Store compiles with new scope-first state fields and no TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement scope + CRUD actions (projects, packages) and scope-aware loaders</name>
  <files>src/stores/bom-store.ts</files>
  <action>
Implement store actions using the new DB helpers:

Job project actions:
- `loadJobProjects()` (fetch all job projects)
- `createJobProjectWithInitialPackage(values)` that creates a job project + first package in one flow (use DB `transaction()` in real mode if available; in mock just do sequential). Input should include `project_number` + `package_name` (and optional name/description stored on package).
- `renameJobProject(id, newProjectNumber)`
- `deleteJobProject(id)`

Package actions:
- `loadPackages(projectId)`
- `createPackage(projectId, packageName, optional fields...)`
- `renamePackage(packageId, newPackageName)`
- `deletePackage(packageId)`

Scope actions:
- `setScope(packageId)`:
  - await `flushPendingWrites()`
  - set `currentScopePackageId`
  - clear location/item UI state (`currentLocationId`, `selectedItemIds`, `searchTerm` if appropriate)
  - load locations and then items for the selected scope
- `clearScope()` (sets scope null and clears locations/items)
- `ensureScopeSelected()` (used by UI to decide whether to force the modal open)

Persistence across navigation/restarts:
- On `setScope`, call `settings.set('bom.active_package_id', String(packageId))`.
- Provide `loadLastScope()` that reads the setting and stores it as a “last used package id” (for preselecting in the modal) but DOES NOT auto-bypass the modal (context requires modal always opens on BOM entry).

Error handling:
- Keep `error` in store for non-field errors.
- Do not toast here; UI will handle toast/surface inline errors.
  </action>
  <verify>
Run: `npm run build`
  </verify>
  <done>
Store exposes project/package CRUD and scope selection that loads locations/items for the active package.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds.
</verification>

<success_criteria>
- A single selected `currentScopePackageId` drives all BOM data loading.
- Switching scope resets the view and loads the new scope’s locations/items.
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-package-scoping-entry-ux/01-03-SUMMARY.md`
</output>
